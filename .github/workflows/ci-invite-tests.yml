name: CI - Playwright Invite Tests

on:
  push:
    branches: [ main, Add/Features ]
  pull_request:
    branches: [ main ]
  schedule:
    - cron: '0 3 * * *' # nightly at 03:00 UTC

jobs:
  playwright-invite-tests:
    runs-on: ubuntu-latest
    env:
      # For matrix Playwright runs we prefer an in-memory fallback to avoid
      # flaky external Atlas/TLS networking issues from runners. Leave
      # `MONGO_URI`/`MONGODB_URI` blank so the server falls back to memory.
      MONGO_URI: ''
      MONGODB_URI: ''
      JWT_SECRET: ${{ secrets.JWT_SECRET }}
    strategy:
      matrix:
        browser: [chromium, webkit, firefox]
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      - name: Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version: '22'

      - name: CI diagnostics - Node & npm
        run: |
          echo "Node version:"; node -v
          echo "Node process.versions:"; node -p "JSON.stringify(process.versions)"
          echo "npm version:"; npm -v

      - name: Install dependencies
        run: npm ci

      - name: CI diagnostics - Mongo connectivity
        if: always()
        continue-on-error: true
        run: |
          node scripts/ci-mongo-check.js

      - name: Install Playwright browsers
        run: npx playwright install --with-deps

      - name: Start server in background
        run: |
          # server will pick up MONGO_URI / JWT_SECRET from the environment if provided
          nohup node server/index.js > server-${{ matrix.browser }}.log 2>&1 &

      - name: Wait for server health (ci health-check)
        run: |
          # uses scripts/ci-health-check.js to poll the health endpoint
          # Increase timeout for server readiness in CI to reduce flakes
          HEALTH_TIMEOUT=180000 HEALTH_POLL_INTERVAL=1000 node scripts/ci-health-check.js

      - name: Build and start frontend (Vite preview) in background
        if: always()
        run: |
          # build the frontend and start a stable preview server for CI
          # building ensures assets are available and preview reliably serves on port 5173
          npm run build
          nohup npx vite preview --port 5173 --strictPort > frontend-${{ matrix.browser }}.log 2>&1 &
          # wait for frontend preview (up to 120s)
          for i in {1..120}; do
            if curl -sSf http://localhost:5173/ >/dev/null; then
              echo "frontend ready"
              break
            fi
            sleep 1
          done

      - name: "Run Playwright tests for ${{ matrix.browser }}"
        run: |
          # Record traces on failure and retain screenshots on failure; fail the step when tests fail
          ARGS=("--project=${{ matrix.browser }}" "--reporter=html" "--trace=retain-on-failure")
          if [ "${{ matrix.browser }}" = "firefox" ]; then
            # Give Firefox a couple of automatic retries to reduce flakes
            ARGS+=("--retries=2")
            # Run Firefox with a single worker to reduce concurrency flakiness
            ARGS+=("--workers=1")
          fi
          npx playwright test "${ARGS[@]}"
          if [ -d playwright-report ]; then mv playwright-report playwright-report-${{ matrix.browser }}; fi
          if [ -d test-results ]; then mv test-results test-results-${{ matrix.browser }}; fi

      - name: Ensure Playwright artifact dirs exist
        if: always()
        run: |
          # create artifact directories with a .gitkeep marker if Playwright produced nothing
          for d in playwright-report-${{ matrix.browser }} test-results-${{ matrix.browser }}; do
            if [ ! -d "$d" ]; then
              mkdir -p "$d"
              echo "placeholder" > "$d/.gitkeep"
            fi
          done

      - name: List Playwright outputs (debug)
        if: always()
        run: |
          echo "Listing playwright-report and test-results for ${{ matrix.browser }}"
          if [ -d "playwright-report-${{ matrix.browser }}" ]; then ls -la "playwright-report-${{ matrix.browser }}" || true; else echo "no playwright-report-${{ matrix.browser }}"; fi
          if [ -d "test-results-${{ matrix.browser }}" ]; then ls -la "test-results-${{ matrix.browser }}" || true; else echo "no test-results-${{ matrix.browser }}"; fi

      - name: Pack Playwright outputs (tar.gz)
        if: always()
        run: |
          set -e
          for d in playwright-report-${{ matrix.browser }} test-results-${{ matrix.browser }}; do
            archive="${d}.tar.gz"
            if [ -d "$d" ] && [ "$(ls -A $d)" ]; then
              echo "Creating archive $archive from $d"
              tar -czf "$archive" -C "$d" .
            else
              echo "No files in $d; creating placeholder and archiving"
              mkdir -p "$d"
              echo "placeholder" > "$d/.gitkeep"
              tar -czf "$archive" -C "$d" .
            fi
          done

      - name: Upload packaged Playwright outputs
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: packaged-playwright-outputs-${{ matrix.browser }}
          path: |
            playwright-report-${{ matrix.browser }}.tar.gz
            test-results-${{ matrix.browser }}.tar.gz

      - name: Upload Playwright HTML report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: playwright-report-${{ matrix.browser }}
          path: playwright-report-${{ matrix.browser }}

      - name: Upload test-results (traces/screenshots)
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: test-results-${{ matrix.browser }}
          path: test-results-${{ matrix.browser }}

      - name: Upload server log
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: server-log-${{ matrix.browser }}
          path: server-${{ matrix.browser }}.log

      - name: CI DB invite audit
        if: always()
        continue-on-error: true
        run: |
          node scripts/ci-invite-audit.js > invite-audit-${{ matrix.browser }}.txt || true

      - name: Upload CI invite audit
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: invite-audit-${{ matrix.browser }}
          path: invite-audit-${{ matrix.browser }}.txt

  nightly-snapshots:
    runs-on: ubuntu-latest
    env:
      MONGO_URI: ${{ secrets.MONGO_URI }}
      MONGODB_URI: ${{ secrets.MONGODB_URI }}
      JWT_SECRET: ${{ secrets.JWT_SECRET }}
    if: ${{ github.event_name == 'schedule' }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      - name: Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version: '22'

      - name: CI diagnostics - Node & npm
        run: |
          echo "Node version:"; node -v
          echo "Node process.versions:"; node -p "JSON.stringify(process.versions)"
          echo "npm version:"; npm -v

      - name: CI diagnostics - Mongo connectivity
        if: always()
        continue-on-error: true
        run: |
          node scripts/ci-mongo-check.js

      - name: Install dependencies
        run: npm ci

      - name: Install Playwright browsers
        run: npx playwright install --with-deps

      - name: Start server in background
        run: |
          nohup node server/index.js > server-nightly.log 2>&1 &
          for i in {1..60}; do
            if curl -sSf http://localhost:3001/api/_health >/dev/null; then
              echo "server ready"
              break
            fi
            sleep 1
          done

      - name: Run nightly Playwright suite (retain traces on failure)
        run: |
          npx playwright test --reporter=html --trace=retain-on-failure
          if [ -d playwright-report ]; then mv playwright-report playwright-report-nightly; fi
          if [ -d test-results ]; then mv test-results test-results-nightly; fi
        continue-on-error: true

      - name: Upload nightly HTML report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: playwright-report-nightly
          path: playwright-report-nightly

      - name: Upload nightly test-results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: test-results-nightly
          path: test-results-nightly

      - name: Upload nightly server log
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: server-log-nightly
          path: server-nightly.log
