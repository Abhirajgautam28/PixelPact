name: CI - Playwright Invite Tests

on:
  push:
    branches: [ main, Add/Features ]
  pull_request:
    branches: [ main ]
  schedule:
    - cron: '0 3 * * *' # nightly at 03:00 UTC

jobs:
  playwright-invite-tests:
    runs-on: ubuntu-latest
    env:
      # Provide MongoDB Atlas connection string and JWT secret via GitHub Secrets.
      # Do NOT commit secrets to the repository; set these in the repository settings
      # under Settings → Secrets & variables → Actions.
      MONGO_URI: ${{ secrets.MONGO_URI }}
      MONGODB_URI: ${{ secrets.MONGODB_URI }}
      JWT_SECRET: ${{ secrets.JWT_SECRET }}
    strategy:
      matrix:
        browser: [chromium, webkit, firefox]
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Use Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 18

      - name: Install dependencies
        run: npm ci

      - name: Install Playwright browsers
        run: npx playwright install --with-deps

      - name: Start server in background
        run: |
          # server will pick up MONGO_URI / JWT_SECRET from the environment if provided
          nohup node server/index.js > server-${{ matrix.browser }}.log 2>&1 &
          # wait for health endpoint (up to 30s)
          for i in {1..30}; do
            if curl -sSf http://localhost:3001/api/_health >/dev/null; then
              echo "server ready"
              break
            fi
            sleep 1
          done

      - name: Start frontend (Vite) in background
        run: |
          # start Vite dev server so Playwright can access the frontend on known ports
          nohup npm run dev -- --host > frontend-${{ matrix.browser }}.log 2>&1 &
          # wait for frontend preview (up to 60s)
          for i in {1..60}; do
            if curl -sSf http://localhost:5173/ >/dev/null; then
              echo "frontend ready"
              break
            fi
            sleep 1
          done

      - name: "Run Playwright tests for ${{ matrix.browser }}"
        run: |
          # Record traces on failure and retain screenshots on failure; fail the step when tests fail
          npx playwright test --project=${{ matrix.browser }} --reporter=html --trace=retain-on-failure
          if [ -d playwright-report ]; then mv playwright-report playwright-report-${{ matrix.browser }}; fi
          if [ -d test-results ]; then mv test-results test-results-${{ matrix.browser }}; fi

      - name: Ensure Playwright artifact dirs exist
        if: always()
        run: |
          # create artifact directories with a .gitkeep marker if Playwright produced nothing
          for d in playwright-report-${{ matrix.browser }} test-results-${{ matrix.browser }}; do
            if [ ! -d "$d" ]; then
              mkdir -p "$d"
              echo "placeholder" > "$d/.gitkeep"
            fi
          done

      - name: Upload Playwright HTML report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: playwright-report-${{ matrix.browser }}
          path: playwright-report-${{ matrix.browser }}

      - name: Upload test-results (traces/screenshots)
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: test-results-${{ matrix.browser }}
          path: test-results-${{ matrix.browser }}

      - name: Upload server log
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: server-log-${{ matrix.browser }}
          path: server-${{ matrix.browser }}.log

  nightly-snapshots:
    runs-on: ubuntu-latest
    env:
      MONGO_URI: ${{ secrets.MONGO_URI }}
      MONGODB_URI: ${{ secrets.MONGODB_URI }}
      JWT_SECRET: ${{ secrets.JWT_SECRET }}
    if: ${{ github.event_name == 'schedule' }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Use Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 18

      - name: Install dependencies
        run: npm ci

      - name: Install Playwright browsers
        run: npx playwright install --with-deps

      - name: Start server in background
        run: |
          nohup node server/index.js > server-nightly.log 2>&1 &
          for i in {1..60}; do
            if curl -sSf http://localhost:3001/api/_health >/dev/null; then
              echo "server ready"
              break
            fi
            sleep 1
          done

      - name: Run nightly Playwright suite (retain traces on failure)
        run: |
          npx playwright test --reporter=html --trace=retain-on-failure
          if [ -d playwright-report ]; then mv playwright-report playwright-report-nightly; fi
          if [ -d test-results ]; then mv test-results test-results-nightly; fi
        continue-on-error: true

      - name: Upload nightly HTML report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: playwright-report-nightly
          path: playwright-report-nightly

      - name: Upload nightly test-results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: test-results-nightly
          path: test-results-nightly

      - name: Upload nightly server log
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: server-log-nightly
          path: server-nightly.log
